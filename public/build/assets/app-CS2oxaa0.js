let r=[],i=5,l=1;function g(){const o=document.querySelector("form");o&&o.addEventListener("submit",h);const e=document.getElementById("addContactBtn");e&&e.addEventListener("click",()=>{o&&(o.reset(),o.removeAttribute("data-edit-index"))});const t=document.getElementById("searchBtn");t&&t.addEventListener("click",s);const n=document.getElementById("search");n&&(n.addEventListener("input",s),n.addEventListener("keypress",a=>{a.key==="Enter"&&s()}))}document.addEventListener("DOMContentLoaded",()=>{console.log("Aplicação inicializada"),g(),u()});async function u(){try{const o=await fetch("/api/contatos");if(!o.ok)throw new Error("Erro ao buscar contatos");r=await o.json(),console.log("Contatos carregados:",r),m()}catch(o){console.error("Erro ao buscar contatos:",o),alert("Erro ao carregar contatos. Por favor, tente novamente.")}}function m(){const o=(l-1)*i,e=o+i,t=[...r].slice(o,e);p(t),E(r.length)}function p(o){const e=document.getElementById("contacts-list");e&&(e.innerHTML="",o.forEach(t=>{const n=r.findIndex(d=>d.id===t.id),a=document.createElement("tr");a.innerHTML=`
            <td>${n+1}</td>
            <td>${t.name}</td>
            <td>${t.telefone}</td>
            <td>${t.idade}</td>
            <td>
                <button class="btn btn-primary editar-contato" data-index="${n}">Editar</button>
                <button class="btn btn-danger excluir-contato" data-index="${n}">Excluir</button>
                <button class="btn btn-info expandir-contato" data-index="${n}">▼</button>
            </td>
        `,e.appendChild(a);const c=document.createElement("tr");c.classList.add("contato-detalhes"),c.innerHTML=`
            <td colspan="5">
                <div id="contato-detalhes-${n}" style="display: none;">
                    <p><strong>CEP:</strong> ${t.cep}</p>
                    <p><strong>Rua:</strong> ${t.rua}</p>
                    <p><strong>Número:</strong> ${t.numero}</p>
                    <p><strong>Complemento:</strong> ${t.complemento||""}</p>
                    <p><strong>Cidade:</strong> ${t.cidade}</p>
                    <p><strong>Estado:</strong> ${t.estado}</p>
                </div>
            </td>
        `,e.appendChild(c)}),document.querySelectorAll(".editar-contato").forEach(t=>{t.addEventListener("click",function(){const n=this.getAttribute("data-index");y(parseInt(n))})}),document.querySelectorAll(".excluir-contato").forEach(t=>{t.addEventListener("click",function(){const n=this.getAttribute("data-index");v(parseInt(n))})}),document.querySelectorAll(".expandir-contato").forEach(t=>{t.addEventListener("click",function(){const n=this.getAttribute("data-index"),a=document.getElementById(`contato-detalhes-${n}`);a&&(a.style.display=a.style.display==="none"?"block":"none")})}))}function E(o){const e=document.getElementById("pagination");if(!e)return;e.innerHTML="";const t=Math.ceil(o/i);for(let n=1;n<=t;n++){const a=document.createElement("li");a.classList.add("page-item"),a.classList.toggle("active",n===l),a.innerHTML=`<a class="page-link" href="#" data-page="${n}">${n}</a>`,e.appendChild(a)}document.querySelectorAll(".page-link").forEach(n=>{n.addEventListener("click",a=>{a.preventDefault(),l=parseInt(n.getAttribute("data-page")),m()})})}function s(){const o=document.getElementById("search");if(!o)return;const e=o.value.toLowerCase();if(e==="")m();else{const t=r.filter(n=>n.name.toLowerCase().includes(e)||n.telefone.includes(e));p(t),E(t.length)}}async function h(o){o.preventDefault();const e=new FormData(o.target),t=Object.fromEntries(e.entries()),n=o.target.getAttribute("data-edit-index");try{let a;if(n!==null){const f=r[n].id;a=await fetch(`/api/contatos/${f}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(t)})}else a=await fetch("/api/contatos",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify(t)});if(!a.ok)throw new Error("Erro ao salvar contato");await u(),o.target.reset(),o.target.removeAttribute("data-edit-index");const c=document.getElementById("contactModal"),d=bootstrap.Modal.getInstance(c);d?d.hide():new bootstrap.Modal(c).hide()}catch(a){console.error("Erro ao salvar contato:",a),alert("Erro ao salvar contato. Por favor, tente novamente.")}}function y(o){const e=r[o],t=document.querySelector("form");if(!t)return;t.querySelector('[name="name"]').value=e.name,t.querySelector('[name="telefone"]').value=e.telefone,t.querySelector('[name="idade"]').value=e.idade,t.querySelector('[name="cep"]').value=e.cep,t.querySelector('[name="rua"]').value=e.rua,t.querySelector('[name="numero"]').value=e.numero,t.querySelector('[name="complemento"]').value=e.complemento||"",t.querySelector('[name="cidade"]').value=e.cidade,t.querySelector('[name="estado"]').value=e.estado,t.setAttribute("data-edit-index",o);const n=document.getElementById("contactModal");new bootstrap.Modal(n).show()}async function v(o){if(confirm("Tem certeza que deseja excluir este contato?"))try{const e=r[o].id;if(!(await fetch(`/api/contatos/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}})).ok)throw new Error("Erro ao excluir contato");await u()}catch(e){console.error("Erro ao excluir contato:",e),alert("Erro ao excluir contato. Por favor, tente novamente.")}}
